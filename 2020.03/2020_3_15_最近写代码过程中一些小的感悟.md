## 写代码过程中一些体会

总结一句话就是：选择适合的工具代替你去做上下游工作，让自己的代码专注于业务核心逻辑。

在开发的后端开发的过程中，有大量的数据验证的需求，如路由参数的验证、Json 字段验证、数据重复等。

把这些数据验证的代码写在核心逻辑中，会让代码十分凌乱。同时，写大量数据验证代码，也容易出 Bug。

所以，把参数验证的过程交给工具来做是一个更好的选择，能够让代码逻辑清晰，容易维护。

下面通过三个例子，来讲解一下：

### 使用工具对 URL 参数进行解析、验证

很多请求都是通过 URL 来传递查询参数,有时候对这些参数还有不同要求，比如数据类型的转换、强制参数等。

我们使用 Flask-Restful 作为开发框架，它提供了一个 reqparse 方法可以用来对 URL 参数进行解析和验证。

```
import flask_restful.reqparse

parser = flask_restful.reqparse.RequestParser()

# 解析的参数名为 rate，数据类型为 int
parser.add_argument('rate', type=int)

# 解析的参数名为 resource_type，数据类型为 str；
# location 是参数解析的位置，args 指从 url query 中解析，也支持从form、headers、cookies 等位置解析；
# required 是要求这个参数是否为必选项；
# choices 是要求这个参数是一个枚举类型。
parser.add_argument("resource_type", 
                    type=str, 
                    location="args", 
                    required=True, 
                    choices=['server', 'app_internal'])
args = parser.parse_args()

# 获取参数
rate = args.get("rate")
name = args.get("name")
resource_type = args.get("resource_type")
```

通过上面的实例，可以看到对需要解析的属性添加相应的参数，即可完成数据的校验，大大的方便了整个数据校验的过程。

### 使用 Json Schema Validator 对 Json 进行解析、验证

使用 Json Validator 对 Json 格式请求验证与 URL 参数有异曲同工之效。

下面举个例子

```
import jsonschema

# 关于 Json Schema 之前有文章简单介绍了，以下是一个略微复杂的 Json Schema 的例子。
json_schema = {
    "type": "object",
    "properties": {
        # resource_type 是一个 String 类型的数据，且为一个枚举类型。
        "resource_type": {"type": "string",
                          "enum": [
                              "server",
                              "app_internal"
                          ]
                          },
    },
    # 这里是一个条件语句，表示# 当 resourc 满足且仅满足 oneOf 数组中的一个Schema
    "oneOf": [
        {   
            # 当 resource_type 为 "server" 执行以下 Json Schema 验证
            "if": {
                "properties": {"resource_type": {"const": "server"}}
            },
            "then": {
                "properties": {
                    "server_data": {
                        "type": "object",
                        "properties": {
                            "hostname": {"type": "string"},
                            "description": {"type": "string"},
                            "instance_id": {"type": "string"},
                        },
                        "required": ["hostname"]
                    }
                },
            }
        },
        {   
            # 当 resource_type 为 "app_internal" 执行以下 Json Schema 验证
            "if": {
                "properties": {"resource_type": {"const": "app_internal"}}
            },
            "then": {
                "properties": {
                    "app_internal_data": {
                        "type": "object",
                        "properties": {
                            "app_name": {"type": "string"},
                            "description": {"type": "string"},
                            "url": {"type": "string"},
                            "dept_id": {"type": "integer"},
                        },
                        "required": ["app_name", "dept_id"]
                    }
                }
            }
        },

    ],
    # required 是一个 必选参数
    "required": ["resource_type"]
}

# 通过 Flask 获得请求 Json
body = flask.request.get_json(force=True)
# 验证请求 Json 是否符合 Json Schema
try:
    jsonschema.validate(body, schema)

# 不符合 Json Schema 则抛出错误
except Exception as e:
    raise ClientError(message="invalid json :[{0}].".format(repr(e)))
else:
    return body

```

以上就是一个通过 Json Schema 来验证数据的例子。

这些判断完全可以在主要的业务逻辑之外完成，让代码更加专注的完成公共。

### 利用数据库约束来进行数据验证


将专业的事情交给专业的工具去做，让自己的代码专注于核心的业务逻辑。这就是最近一些写代码的感受。